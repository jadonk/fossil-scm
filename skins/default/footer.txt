<div class="footer">
This page was generated in about
<th1>puts [expr {([utime]+[stime]+1000)/1000*0.001}]</th1>s by
Fossil $release_version $manifest_version $manifest_date
</div>

<th1>
  html "<script nonce='$nonce'>"
  html "  (function() { var home='$home'; "
</th1>
    var panel = document.getElementById("hbdrop");
    if (!panel) return;   // site admin might've nuked it
    var panelBorder = panel.style.border;
    var animate = panel.style.hasOwnProperty('transition');
    var animMS = 400;

    // Calculate panel height despite its being hidden at call time.
    // Based on https://stackoverflow.com/a/29047447/142454
    var panelHeight;  // computed on sitemap load
    function calculatePanelHeight() {
      // Get initial panel styles so we can restore them below.
      var es   = window.getComputedStyle(panel),
          edis = es.display,
          epos = es.position,
          evis = es.visibility;

      // Restyle the panel so we can measure its height while invisible.
      panel.style.visibility = 'hidden';
      panel.style.position   = 'absolute';
      panel.style.display    = 'block';
      panelHeight = panel.offsetHeight + 'px';

      // Revert styles now that job is done.
      panel.style.display    = edis;
      panel.style.position   = epos;
      panel.style.visibility = evis;
    }

    // Show the panel by changing the panel height, which kicks off the
    // slide-open/closed transition set up in the XHR onload handler.
    //
    // Schedule the change for a near-future time in case this is the
    // first call, where the div was initially invisible.  That causes
    // the browser to consider the height change as part of the same
    // state change as the visibility change, so it doesn't see a state
    // *transition*, hence never kicks off the *CSS* transition:
    //
    // https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Transitions/Using_CSS_transitions#JavaScript_examples
    function showPanel() {
      if (animate) {
        setTimeout(function() {
          panel.style.maxHeight = panelHeight;
          panel.style.border    = panelBorder;
        }, 40);   // 25ms is insufficient with Firefox 62
      }
      else {
        panel.style.display = 'block';
      }
    }

    // Return true if the panel is showing.
    function panelShowing() {
      if (animate) {
        return panel.style.maxHeight == panelHeight;
      }
      else {
        return panel.style.display == 'block';
      }
    }

    // Click handler for the hamburger button.
    var needSitemapHTML = true;
    document.querySelector("div.mainmenu > a").onclick = function() {
      if (panelShowing()) {
        // Transition back to hidden state.
        if (animate) {
          panel.style.maxHeight = '0';
          setTimeout(function() {
            // Browsers show a 1px high border line when maxHeight == 0,
            // our "hidden" state, so hide the borders in that state, too.
            panel.style.border = 'none';
          }, animMS);
        }
        else {
          panel.style.display = 'none';
        }
      }
      else if (needSitemapHTML) {
        // Only get it once per page load: it isn't likely to
        // change on us.
        var xhr = new XMLHttpRequest();
        xhr.onload = function() {
          var doc = xhr.responseXML;
          if (doc) {
            var sm = doc.querySelector("ul#sitemap");
            if (sm && xhr.status == 200) {
              // Got sitemap.  Insert it into the drop-down panel.
              needSitemapHTML = false;
              panel.innerHTML = sm.outerHTML;
              if (window.setAllHrefs) {
                setAllHrefs();   // don't need anti-robot defense here
              }

              // Display the panel
              if (animate) {
                // Set up a CSS transition to animate the panel open and
                // closed.  Only needs to be done once per page load.
                // Based on https://stackoverflow.com/a/29047447/142454
                calculatePanelHeight();
                panel.style.transition = 'max-height ' +
                    (animMS / 1000) + 's ease-in-out';
                panel.style.overflowY  = 'hidden';
                panel.style.maxHeight  = '0';
                showPanel();
              }
              panel.style.display = 'block';
            }
          }
          // else, can't parse response as HTML or XML
        }
        xhr.open("GET", home + "/sitemap");
        xhr.responseType = "document";
        xhr.send();
      }
      else {
        showPanel();   // just show what we built above
      }
      return false;  // prevent browser from acting on <a> click
    }
  })();
</script>
